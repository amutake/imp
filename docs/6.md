6. 環境とクロージャ
===================

環境は、言語に関数 (クロージャ) がなければ State モナドもしくは引数にして引き回しでいいのですが、今回の言語は関数があるので純粋な State モナドは使えず、IORef または STRef という、参照型を使わなければいけません。今回は STRef より扱いやすい (と自分は思っている) IORef を使います。

環境の型 Env は以下のようになります。

```haskell
type Env = IORef EnvList

data EnvList = Last (Map Id Value)
             | Cons (Map Id Value) Env
```

例えば、

```javascript
var x = 0;
var y = 0;
var z = 0;
var f = fun(x) {
  // (2)
  var y = 1;
  z = 1;
  // (3)
};
// (1)
f(1);
// (4)
```

だと、

(1) の時点では環境は以下のようになっています。(矢印は参照してます的な意味)

```
   | x -> 0         |
-> | y -> 0         |
   | z -> 0         |
   | f -> <closure> |
```

(2) では関数が呼ばれ、空の環境が作られて Cons されて関数の中に入ります。そして仮引数の x に 1 がバインドされます。

```
                 | x -> 0         |
-> | x -> 1 | -> | y -> 0         |
                 | z -> 0         |
                 | f -> <closure> |
```

(3) では以下のようになります。var は先頭の環境に変数が作られますが、代入はその変数が見つかるまで環境を辿って行き、見つかったらその値を書き換えます。

```
   | x -> 1 |    | x -> 0         |
-> | y -> 1 | -> | y -> 0         |
                 | z -> 1         |
                 | f -> <closure> |
```

(4) では戻ってきます。関数によって z の値が書き換えられています。

```
   | x -> 0         |
-> | y -> 0         |
   | z -> 1         |
   | f -> <closure> |
```
